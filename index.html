<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="./styles/global.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    i {
      animation-iteration-count: 1 !important;
      animation-delay: 500ms !important;
      -webkit-animation-iteration-count: 1 !important;
      -webkit-animation-delay: 500ms !important;
    }

    .table td,
    .table th {
      background-color: var(--ios-bg);
      color: var(--ios-text);
      font-size: var(--font-sm2);
    }

    .table thead th {
      color: var(--ios-text2);
      font-size: var(--font-sm5);
      font-weight: 500;
      border: none;
    }

    .table tbody tr td {
      border-top: 1px solid var(--ios-bg1);
      border-bottom: none;
    }

    .table.shrunken {
      max-height: 35dvh !important;
      overflow-y: scroll;
      display: inline-block;
    }

    body,
    html {
      height: -webkit-fill-available;
    }

    /* .chart-container {
      position: relative;
      height: calc(100dvh)
    } */

    tr.inactive td {
      opacity: .4 !important;
      /* font-size: var(--font-sm5) !important; */

    }
  </style>
</head>


<body class="m-0 p-0 mx-auto" style="max-width: 600px;">
  <nav id="navCont" class="navbar">
    <div class="container-fluid">
      <a class="navbar-brand" href="/nfl-pickem/index.html">
        <div class="d-flex align-items-center mx-0 px-0">
          <i class="fa-solid fa-football fa-sm d-inline-block align-text-top"></i>
          <span class="ps-2">PICK 'EM</span>
        </div>
      </a>
      <div class="navbar-nav d-flex flex-row nav-underline">
        <a id="nav-standings" class="nav-link fw-medium active" href="/nfl-pickem/index.html">Standings</a>
        <a id="nav-schedule" class="nav-link fw-medium" href="/nfl-pickem/schedule.html">Schedule</a>
      </div>
    </div>
  </nav>

  <div id="main" class="container-fluid px-2 mt-4 mb-4">
    <div class="table-responsive">
      <table id="tblStandings" class="table align-middle text-center text-nowrap">
      </table>
    </div>
    <!-- add wpct button -->
  </div>
  <div id="chartDiv" class="chart-container d-none">
    <canvas id="chart"></canvas>
  </div>
  </div>


  <template id="row-template">
    <tr>
      <td data-item="rank" class="text-end text-primary-emphasis text-sm5 fw-medium pe-0"></td>
      <td data-item="player-cont" class="fw-medium text-start pe-4">
        <div class="d-flex flex-row align-items-center py-0">
          <span data-item="player" class="pe-2"></span>
          <i data-item="change-icon" class="d-none"></i>
          <span data-item="change" class="d-none text-sm5 ps-1"></span>
        </div>
      </td>
      <td data-item="rec_week" class=""></td>
      <td data-item="rec" class=""></td>
      <td data-item="gb" class="text-dim1"></td>
      <td data-item="pc_dog_pick" class="text-dim1"></td>
      <td data-item="pc_dog_win" class="text-dim1"></td>
    </tr>
  </template>
  <script src="./scripts/global/data.js"></script>
  <script src="./scripts/global/chart-utils.js"></script>

  <script src="./scripts/page-charts/DATA.js"></script>
  <script src="./scripts/page-charts/elements.js"></script>
  <script src="./scripts/page-charts/chart.js"></script>
  <script>
    let DATA = {};
    let chart;

    sendData();

    async function showChart() {
      if (!document.getElementById('chartDiv').style.height) {
        document.getElementById('tblStandings').classList.add('shrunken');
        let currHeight = 0;
        let els = ['navCont', 'main'];
        els.forEach((x) => {
          let el = document.getElementById(x);
          let h = el.offsetHeight;
          h += parseInt(window.getComputedStyle(el).getPropertyValue('margin-top'));
          h += parseInt(window.getComputedStyle(el).getPropertyValue('margin-bottom'));
          currHeight += h;
        });

        // adjust for toolbar
        currHeight += 85;

        let cssDVH = `calc(100vh - ${currHeight}px)`;
        let chartDiv = document.getElementById('chartDiv');
        chartDiv.style.height = cssDVH;
      }
    }

    async function hideChart() {
      document.getElementById('tblStandings').classList.remove('shrunken');
      document.getElementById('chartDiv').style.height = '';
    }

    /* ------------------------------------------------ */

    async function sendData() {
      const data = await getSheet('PlayerStats');
      DATA.Stats = procStats(data);
      DATA.tblStandings = procStandings();

      DATA.Chart = procChartData(DATA.Stats);
      DATA.Chart.active.fields.push(...['rank', 'wpct']);

      console.log(DATA.Chart);
      // logHeightValues();

      updateTblStandings();
      logHeightValues();

      // updateChart({
      //   mode: 'byStat',
      //   field: 'rank',
      //   player: 'Jordan'
      // });
    }

    function logHeightValues() {
      // get all height vars (e.g., clientHeight, offsetHeight, scrollHeight, innerHeight, offsetHeight, etc.)
      // for the window, document, body, and chartDiv
      // log results in json format to console
      let heights = {
        ht_window: {
          clientHeight: window.document.documentElement.clientHeight,
          innerHeight: window.innerHeight,
          outerHeight: window.outerHeight,
          offsetHeight: window.document.documentElement.offsetHeight,
          scrollHeight: window.document.documentElement.scrollHeight,
          // availHeight: window.screen.availHeight,
          height: window.screen.height,
        },
        ht_document: {
          clientHeight: document.documentElement.clientHeight,
          innerHeight: document.innerHeight,
          outerHeight: document.outerHeight,
          offsetHeight: document.documentElement.offsetHeight,
          scrollHeight: document.documentElement.scrollHeight,
        },
        ht_body: {
          clientHeight: document.body.clientHeight,
          innerHeight: document.body.innerHeight,
          outerHeight: document.body.outerHeight,
          offsetHeight: document.body.offsetHeight,
          scrollHeight: document.body.scrollHeight,
          // availHeight: document.body.screen.availHeight,
          // height: document.body.screen.height,
        },
        ht_chartDiv: {
          clientHeight: document.getElementById('chartDiv').clientHeight,
          innerHeight: document.getElementById('chartDiv').innerHeight,
          outerHeight: document.getElementById('chartDiv').outerHeight,
          offsetHeight: document.getElementById('chartDiv').offsetHeight,
          scrollHeight: document.getElementById('chartDiv').scrollHeight,
          // availHeight: document.getElementById('chartDiv').screen.availHeight,
          // height: document.getElementById('chartDiv').screen.height,
        },
      }

      let bodyChildren = Array.from(document.body.children);
      // limit to nav and divs
      bodyChildren = bodyChildren.filter(c => c.tagName == 'NAV' || c.tagName == 'DIV');
      bodyChildren.forEach((c) => {
        let id = c.id;
        console.log(id);
        let height = {
          clientHeight: c.clientHeight,
          innerHeight: c.innerHeight,
          outerHeight: c.outerHeight,
          offsetHeight: c.offsetHeight,
          scrollHeight: c.scrollHeight,
          // availHeight: c.screen.availHeight,
          // height: c.screen.height,
        };
        console.log(height);
      })




      console.log(heights);
    }

    /* ------------------------------------------------ */

    function updateTblStandings() {
      let data = DATA.tblStandings;
      let tbl = document.getElementById('tblStandings');
      let thead = tbl.createTHead();
      let tbody = tbl.createTBody();
      let header = thead.insertRow();
      let headerCells = ['', '', 'WK', 'TTL', 'GB', 'D%', 'DW%'];
      headerCells.forEach((h) => {
        let cell = document.createElement('th');
        cell.textContent = h;
        header.appendChild(cell);
      });

      let template = document.getElementById('row-template');

      data.forEach((g) => {
        let clone = template.content.cloneNode(true);
        let row = clone.querySelector('tr');
        row.querySelector('[data-item="rank"]').textContent = g.rank;
        let pcont = row.querySelector('[data-item="player-cont"]');
        let player = pcont.querySelector('[data-item="player"]');
        let changeIcon = pcont.querySelector('[data-item="change-icon"]');
        let change = pcont.querySelector('[data-item="change"]');
        player.textContent = g.player;

        if (parseInt(g.change) > 0) {
          changeIcon.classList.remove('d-none');
          changeIcon.classList.add('fa-regular', 'fa-circle-up', 'fa-sm', 'text-success-emphasis', 'fa-bounce');
          change.classList.remove('d-none');
          change.classList.add('text-success-emphasis');
          change.textContent = g.change.replace('-', '');
        } else if (parseInt(g.change) < 0) {
          changeIcon.classList.remove('d-none');
          changeIcon.classList.add('fa-regular', 'fa-circle-down', 'fa-sm', 'text-danger-emphasis', 'fa-bounce');
          change.classList.remove('d-none');
          change.classList.add('text-danger-emphasis');
          change.textContent = g.change.replace('-', '');
        }

        row.querySelector('[data-item="rec_week"]').textContent = g.rec_week;
        row.querySelector('[data-item="rec"]').textContent = g.rec;
        row.querySelector('[data-item="gb"]').textContent = (g.gb == '') ? '-' : g.gb;
        row.querySelector('[data-item="pc_dog_pick"]').textContent = g.pc_dog_pick;
        row.querySelector('[data-item="pc_dog_win"]').textContent = g.pc_dog_win;

        // clicking row shows chart.js line of rank by week
        row.setAttribute('role', 'button');
        row.setAttribute('data-player', g.player);
        row.addEventListener('click', (e) => {

          toggleRow(e.currentTarget);
          let rows = Array.from(document.getElementById('tblStandings').querySelectorAll('tr'));
          let rowsSelected = rows.filter(tr => !tr.classList.contains('inactive'));
          let showChartDiv = rowsSelected.length != rows.length;
          let players = rowsSelected.map(tr => tr.dataset.player);
          let chartDiv = document.getElementById('chartDiv');

          if (showChartDiv) {
            chartDiv.classList.remove('d-none');
            showChart();
            e.currentTarget.scrollIntoView({
              behavior: 'smooth',
              block: 'center'
            });
            DATA.Chart.active.players = players;
            updateChart();
            logHeightValues();
          } else {
            hideChart();
            chartDiv.classList.add('d-none');
          }

        });

        // add row to table
        tbody.appendChild(clone);
      });
    }

    function toggleRow(row) {
      // let rowInactive = row.classList.contains('inactive');
      let tblRows = Array.from(document.getElementById('tblStandings').querySelectorAll('tr'));
      let isTblFiltered = tblRows.some(tr => tr.classList.contains('inactive'));
      let isRowInactive = row.classList.contains('inactive');

      if (!isTblFiltered || (isTblFiltered && isRowInactive)) {
        tblRows.forEach(tr => tr.classList.add('inactive'));
        row.classList.remove('inactive');
        return;
      }

      if (isTblFiltered && !isRowInactive) {
        tblRows.forEach(tr => tr.classList.remove('inactive'));
        return;
      }
    }


  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous">
  </script>
</body>

</html>
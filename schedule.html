<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/dark.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="./styles/global.css">
  <link rel="stylesheet" href="./scripts/schedule/css/style.css">
  <style>
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: env(safe-area-inset-top);
      background-color: var(--ios-bg);
      z-index: 1000;
    }

    html {
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .modal-header {
      padding-top: env(safe-area-inset-top) !important;
    }

    .modal-footer {
      padding-bottom: env(safe-area-inset-bottom) !important;
      padding-top: 0 !important;
    }

    .modal-body {
      overflow-y: scroll;
      overscroll-behavior: contain;
    }
  </style>
</head>

<body class="m-0 p-0 mx-auto" style="max-width: 600px;">
  <nav id="navCont" class="navbar">
    <div class="container-fluid">
      <a class="navbar-brand" href="/nfl-pickem/index.html">
        <div class="d-flex align-items-center mx-0 px-0">
          <i class="fa-solid fa-football fa-sm d-inline-block align-text-top"></i>
          <span class="ps-2">PICK 'EM</span>
        </div>
      </a>
      <div class="navbar-nav d-flex flex-row nav-underline">
        <a id="nav-standings" class="nav-link fw-medium" href="/nfl-pickem/index.html">Standings</a>
        <a id="nav-schedule" class="nav-link fw-medium active" href="/nfl-pickem/schedule.html">Schedule</a>
      </div>
    </div>
  </nav>
  <div id="main" class="container-fluid mx-0 px-0">
    <div id="view-loading" class="d-none d-flex flex-column justify-content-center align-items-center" style="height: 90vh; width:100%">
      <div class="spinner-border text-main" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="mt-3">
        <h6>Loading...</h6>
      </div>
    </div>
    <div id="tblDetails" class="pb-1 px-1 bg-main">
      <div id="filterCont" class="btn-group d-flex flex-nowrap overflow-x-scroll" role="group">

      </div>
      <div class="d-flex flex-row my-2 align-items-center">
        <div id="prog-games" class="d-none ps-1 pe-3 me-auto" style="width: 65%;">
          <div class="progress-stacked">
            <div id="prog-post" class="progress" role="progressbar" style="width: 0%">
              <div class="progress-bar bg-primary"></div>
            </div>
            <div id="prog-in" class="progress" role="progressbar" style="width: 0%">
              <div class="progress-bar bg-danger"></div>
            </div>
            <div id="prog-pre" class="progress" role="progressbar" style="width: 0%">
              <div class="progress-bar bg-1"></div>
            </div>
          </div>
        </div>
        <button id="toggle-picks-btn" style="width: 25%" class="fw-semibold btn btn-sm btn-primary text-nowrap d-none" type="button" onclick="togglePicks()">Show Picks</button>
        <button id="refresh-btn" class="w-auto mx-0 fw-light btn text-nowrap d-none" type="button" onclick="sendData()"><i class="fa-solid fa-sync-alt"></i></button>
      </div>
    </div>
    <div id="tblGames">
      <!-- game rows-->

    </div>
  </div>
  <div class="modal fade" id="modalFormContainer" tabindex="-1" aria-labelledby="modalFormContainerLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header bg-main border-0">
          <div class="container pt-2">
            <div class="row justify-content-between align-items-center">
              <div class="col-auto text-nowrap">
                <h5 class="modal-title" id="modalFormContainerLabel"></h5>
              </div>
              <div class="col-auto ms-2">
                <div class="row text-dim1 text-sm5" id="modalFormSubtitle"></div>
                <div class="row text-dim1 text-sm5" id="modalFormSubtitle2"></div>
              </div>
              <div class="col-auto ms-auto">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-body p-0 m-0 bg-main">
          <form id="modalForm">
            <div id="modalFormBody" class="container m-0 pt-0">
              <div id="modalFormMeta" class="container sticky-top w-100 pt-0 pb-3 bg-main">
                <div class="row mx-0 align-items-center">
                  <div class="col-9 ps-0">
                    <select class="form-select bg-main m-0 fw-medium" name="player" id="player" required>
                      <option selected>Player</option>
                      <option value="Austin">Austin</option>
                      <option value="Carly">Carly</option>
                      <option value="Carter">Carter</option>
                      <option value="John">John</option>
                      <option value="Jordan">Jordan</option>
                      <option value="Kayla">Kayla</option>
                      <option value="Kristen">Kristen</option>
                      <option value="Kristy">Kristy</option>
                      <option value="Stella">Stella</option>
                    </select>
                  </div>
                  <div class="col-3 pe-0">
                    <button id="form-submit-btn" type="submit" class="no-submit btn btn-primary w-100 text-sm2 fw-medium">Submit</button>

                  </div>
                </div>
              </div>
              <div id="modalFormGames" class="container pt-1">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer modfooter-sticky bg-main">
          <span id="modalMessage" class="text-danger fw-medium d-none"></span>
        </div>
      </div>
    </div>
  </div>

  <template id="tblrow-template">
    <div class="tblrow mx-1">
      <div class="gamerow row align-items-start pt-2 py-3 mx-0" style="border-top-width: 2px; border-top-style: dotted; border-top-color: rgb(47, 47, 47) !important;">
        <div class="teamcol col-9" style="border-right-width: 1px; border-right-style: solid; border-right-color: rgb(47, 47, 47);">
          <div class="d-flex flex-column row-gap-1">
            <div class="teamrow teamrow-away d-flex align-items-center">
              <img data-item="logo" src="" class="object-fit-contain" style="height: 1.2rem; width: 1.2rem;">
              <span data-item="teamshort" class="ps-2 fw-semibold"></span>
              <i data-item="poss" class="fa-solid fa-football fa-sm object-fit-contain ps-2 text-dim2"></i>
              <span data-item="score" class="fw-semibold ms-auto"></span>
              <span data-item="record" class="text-dim1 text-sm5 ms-auto"></span>
            </div>
            <div class="teamrow teamrow-home d-flex align-items-center">
              <img data-item="logo" src="" class="object-fit-contain" style="height: 1.2rem; width: 1.2rem;">
              <span data-item="teamshort" class="ps-2 fw-semibold"></span>
              <i data-item="poss" class="fa-solid fa-football fa-sm object-fit-contain ps-2 text-dim2"></i>
              <span data-item="score" class="fw-semibold ms-auto"></span>
              <span data-item="record" class="text-dim1 text-sm5 ms-auto"></span>
            </div>
          </div>
        </div>
        <div class="statcol col-3">
          <div class="d-flex flex-column justify-content-center text-sm5">
            <span data-item="gameday" class="text-dim1 fw-semibold"></span>
            <span data-item="gametime" class="text-dim1 fw-semibold"></span>
            <span data-item="stateshort" class="fw-semibold"></span>
            <span data-item="poss_loc" class="text-dim1 fw-semibold"></span>
            <span data-item="poss_dd" class="text-dim1 fw-normal"></span>
            <span data-item="spread" class="text-dim1 fw-normal"></span>
          </div>
        </div>
      </div>
      <div class="pickrow row align-items-center pt-0 pb-0 mx-0">
        <div class="col-9 px-0 mb-3 ps-2">
          <div class="pickcont row row-cols-3 rounded-end-3 mx-0 ps-2 pe-1 py-1">
            <div class="col px-1">
              <div class="pickitem d-flex align-items-center py-1" role="button" data-bs-toggle="modal" data-bs-target="#modalFormContainer" tabindex="0">
                <img data-item="pick_logo" src="" class="object-fit-contain" style="height: 16px; width: 16px;">
                <span data-item="player" class="ps-1 small"></span>
                <span data-item="status" class="ps-1 small text-danger-emphasis fw-medium d-none"></span>
              </div>
            </div>
          </div>
        </div>
        <div class="pickdist col-3">

        </div>
      </div>
    </div>
  </template>

  <script src="./scripts/global/data.js"></script>

  <script src="./scripts/schedule/js/procGames.js"></script>
  <script src="./scripts/schedule/js/forms.js"></script>
  <script>
    function setDataAttrs(element, data) {
      Object.keys(data).forEach((key) => {
        let label = key.replace('_', '-');
        element.setAttribute('data-' + label, data[key]);
      });
    }

  </script>
  <script>
    var USING_LIVE = true;
    let DATA = {
      LOADED: false,
      TBL_LOADED: false
    };

    sendData();

    async function getData() {

      if (DATA.LOADED == false) document.getElementById('view-loading').classList.remove('d-none');

      DATA['SeasonInfo'] = await getSheet('SeasonInfo');
      DATA['Games'] = await getSheet('Games');
      DATA['Responses'] = await getSheet('Responses');

      DATA.currweek = DATA.SeasonInfo.filter((x) => x.current == '1')[0]['week'];
      DATA.full = procGames(DATA.Games, DATA.Responses);
      if (USING_LIVE == true) {
        DATA.live = await fetchLive(DATA.currweek);
        DATA.full = updateData(DATA.full, DATA.live);
      }

      if (!DATA.tblGames) {
        DATA.tblGames = DATA.full.filter((x) => x.week == DATA.currweek)[0];
      } else {
        let tblWeek = DATA.tblGames.week;
        DATA.tblGames = DATA.full.filter((x) => x.week == tblWeek)[0];
      }

      if (DATA.LOADED == false) {
        document.getElementById('view-loading').classList.add('d-none');
        DATA.LOADED = true;
      }

      console.log(DATA);
    }

    /* ------------------------------------------------ */

    /* ------------------------------------------------ */

    async function sendData() {

      if (DATA.TBL_LOADED == true) {
        let btn = document.getElementById('refresh-btn');
        let btn_html = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm text-main" role="status" aria-hidden="true"></span>';

        await getData();
        updateTblrows(update = true);
        console.log('updated');

        btn.innerHTML = '';
        btn.innerHTML = btn_html;
      } else {

        await getData();
        updateTblrows(update = false);

        makeWeekButtons();
        document.getElementById("refresh-btn").classList.remove('d-none');
        document.getElementById("toggle-picks-btn").classList.remove('d-none');
        document.getElementById("prog-games").classList.remove('d-none');

        // add event listeners
        let modalForm = document.getElementById('modalForm');
        modalForm.addEventListener('submit', (e) => {
          submitForm(e);
        });
        modalForm.querySelector('select[name="player"]').addEventListener('change', (e) => {
          prepareForm(e);
        });

        let modal = document.getElementById('modalFormContainer');
        // on open, add no-submit to footer
        modal.addEventListener('show.bs.modal', (e) => {
          let submitBtn = document.getElementById('form-submit-btn');
          submitBtn.classList.add('no-submit');
        });

        DATA.TBL_LOADED = true;


      }

    }

    /* ------------------------------------------------ */

    function updateTblrows(update = false) {

      let tblGames = document.getElementById('tblGames');
      let games = DATA.tblGames.games;

      if (update == false) {
        tblGames.innerHTML = '';
        let days = games.map((x) => x.gameday_long);
        days = days.filter((c, index) => days.indexOf(c) === index);
        days.forEach((d) => {
          let dayDiv = document.createElement('div');
          let day = document.createElement('h6');
          day.classList.add('text-center', 'text-dim1', 'fw-semibold', 'pt-3', 'pb-3', 'mb-0', 'mt-0');
          day.textContent = d;
          dayDiv.appendChild(day);
          tblGames.appendChild(dayDiv);

          games.filter((x) => x.gameday_long == d).forEach((g) => {
            let tblrow = makeTblrow(g);
            tblGames.appendChild(tblrow);
          });
        });
      } else {
        let tblrows = tblGames.getElementsByClassName('tblrow');
        for (let i = 0; i < tblrows.length; i++) {
          let tblrow = tblrows.item(i);
          let game_id = tblrow.getAttribute('data-gameid');
          let g = games.filter((x) => x.game_id == game_id)[0];
          let newrow = makeTblrow(g);
          // if pickrow of tblrow has class show, add class show to new pickrow
          let pickrow = tblrow.getElementsByClassName('pickrow')[0];
          if (pickrow.classList.contains('show')) {
            newrow.getElementsByClassName('pickrow')[0].classList.add('show');
          }
          tblrow.replaceWith(newrow);
        }
      }

      ['pre', 'in', 'post'].forEach((state) => {
        let num_games = games.filter((x) => x.state == state).length;
        let pc_games = Math.round(num_games / games.length * 100);
        document.getElementById('prog-' + state).style.width = pc_games + '%';
      });
    }

    /* ------------------------------------------------ */

    function makeTblrow(g) {
      let template = document.getElementById('tblrow-template');
      let clone = template.content.cloneNode(true);
      let tblrow = clone.querySelector('.tblrow');
      tblrow.setAttribute('data-gameid', g.game_id);
      tblrow.classList.add('game-' + g.state);

      let gamerow = tblrow.querySelector('.gamerow');
      gamerow.setAttribute('data-gameid', g.game_id);
      gamerow.setAttribute('data-week', g.week);
      gamerow.setAttribute('data-gametime', g.gametime_raw);
      gamerow.setAttribute('data-deadline', g.deadline);

      ['away', 'home'].forEach((t) => {
        let teamrow = gamerow.querySelector('.teamrow-' + t);
        teamrow.setAttribute('data-gameid', g.game_id);
        teamrow.setAttribute('data-team', g[t + '_team']);
        teamrow.setAttribute('data-teamshort', g[t + '_teamshort']);
        teamrow.setAttribute('data-teamfull', g[t + '_teamfull']);

        ['logo', 'teamshort', 'poss', 'score', 'record'].forEach((item) => {
          let el = teamrow.querySelector('[data-item="' + item + '"]');
          if (item == 'logo') {
            el.src = g[t + '_logo'];
            return;
          }

          if (item == 'poss') {
            if (g[t + '_poss'] != '1') el.classList.add('d-none');
            return;
          }

          if (item == 'score') {
            if (g.state == 'pre') el.classList.add('d-none');
            // return;
          }

          if (item == 'record') {
            if (g.state != 'pre') el.classList.add('d-none');
            // return;
          }

          el.textContent = g[t + '_' + item];
        });

        // add opacity-25 class to teamrow if team didn't win (keep logo at full opacity)
        if (g.state == 'post') {
          if (g[t + '_team'] != g.win_team) {
            let spanEls = teamrow.querySelectorAll('span');
            spanEls.forEach((el) => {
              el.classList.add('opacity-25');
            });
          }
        }
      });

      // fill statcol
      ['gameday', 'gametime', 'stateshort', 'poss_loc', 'poss_dd', 'spread'].forEach((key) => {
        let el = gamerow.querySelector('[data-item="' + key + '"]');
        el.textContent = g[key];
        el.classList.add('d-none');
        if (g.state == 'pre') {
          if (key == 'gameday') el.classList.remove('d-none');
          if (key == 'gametime') el.classList.remove('d-none');
          if (key == 'spread') el.classList.remove('d-none');
        } else if (g.state == 'in') {
          if (key == 'stateshort') {
            el.classList.remove('d-none');
            el.classList.add('text-danger');
          }
          if (key == 'poss_loc') el.classList.remove('d-none');
          if (key == 'poss_dd') el.classList.remove('d-none');
        } else if (g.state == 'post') {
          if (key == 'stateshort') {
            el.classList.remove('d-none');
            el.classList.add('text-primary-emphasis');
          }
          if (key == 'spread') el.classList.remove('d-none');
        }
      });

      // fill pickrow
      if (!g.responses) {
        let pickrow = tblrow.querySelector('.pickrow');
        pickrow.remove();
        return tblrow;
      }

      // pickdist will have donut chart of picks
      // let pickdist = tblrow.querySelector('.pickdist');

      let state = g.state;
      let win_team = g.win_team;

      gamerow.setAttribute('data-bs-toggle', 'collapse');
      gamerow.setAttribute('data-bs-target', '#picks-' + g.game_id);
      gamerow.setAttribute('role', 'button');

      let pickrow = tblrow.querySelector('.pickrow');
      pickrow.classList.add('collapse');
      pickrow.id = 'picks-' + g.game_id;
      pickrow.id = pickrow.id.replace('_', '-');

      let pcols = pickrow.querySelector('.row-cols-3');
      g.responses.forEach((p, index) => {
        let col = pcols.querySelector('.col');
        if (index > 0) {
          let newcol = col.cloneNode(true);
          pcols.appendChild(newcol);
        }
      });

      g.responses.forEach((p, index) => {
        let pickitem = pcols.querySelector('.col:nth-child(' + (index + 1) + ') .pickitem');
        Object.keys(p).forEach((key) => {
          let label = key.replace('_', '-');
          pickitem.setAttribute('data-' + label, p[key]);
        });

        let logo = pickitem.querySelector('[data-item="pick_logo"]');
        logo.src = p.pick_logo;
        if (p.pick_logo == '') logo.classList.add('opacity-0');
        let player = pickitem.querySelector('[data-item="player"]');
        player.textContent = p.player;

        let pick_team = p.pick_team;
        if (p.status != 'OK') {
          pickitem.classList.add('opacity-25');
          let status = pickitem.querySelector('[data-item="status"]');
          if (p.status == 'LATE') {
            status.textContent = 'L';
            status.classList.remove('d-none');
          }
        } else {
          if (state == 'post') {
            if (pick_team == win_team) {
              pickitem.classList.add('opacity-100');
            } else {
              pickitem.classList.add('opacity-25');
            }
          }
        }

        pickitem.addEventListener('click', (e) => {
          prepareForm(e);
        });
      });

      return tblrow;

    }

    /* ------------------------------------------------ */

    function makeWeekButtons() {

      let fCont = document.getElementById('filterCont');
      DATA.full.forEach((wdata) => {
        let w = wdata.week;
        let wlab = wdata.week_label;
        if (!document.getElementById('btn' + w)) {
          let btn = document.createElement('button');
          btn.type = 'button';
          btn.setAttribute('data-week', w);
          btn.addEventListener('click', (e) => {
            let btn = e.target;
            let week = btn.getAttribute('data-week');
            filterTable(week);
          });
          btn.classList.add('btn', 'text-dim2', 'fw-medium', 'text-nowrap', 'rounded-2');
          btn.style.borderColor = 'transparent';
          btn.innerHTML = `${wlab}`;
          btn.id = 'btn' + w;
          fCont.appendChild(btn);
        }
      });

      let currbtn = document.getElementById('btn' + DATA.currweek);
      currbtn.classList.add('active');
      currbtn.scrollIntoView({ behavior: "smooth", block: "end", inline: "center" });
    }

    function filterTable(week) {

      DATA.tblGames = DATA.full.filter((x) => x.week == week)[0];
      updateTblrows();

      let fCont = document.getElementById('filterCont');
      let btns = fCont.getElementsByClassName('btn');
      for (let j = 0; j < btns.length; j++) {
        let btn = btns.item(j);
        let btn_week = btn.getAttribute('data-week');
        if (btn_week == week) {
          btn.classList.add('active');
          btn.scrollIntoView({ behavior: "smooth", block: "end", inline: "center" });
        } else {
          btn.classList.remove('active');
        }
      }
    }

    /* ------------------------------------------------ */

    function togglePicks() {

      let btn = document.getElementById('toggle-picks-btn');
      let picks_on = btn.innerHTML.includes('Hide') == true;
      if (picks_on == true) btn.innerHTML = 'Show Picks';
      if (picks_on == false) btn.innerHTML = 'Hide Picks';

      let tbl = document.getElementById('tblGames');
      let rows = tbl.getElementsByClassName('pickrow');
      for (let i = 0; i < rows.length; i++) {
        let row = rows.item(i);
        let is_shown = row.classList.contains('show') == true;
        if (!picks_on) {
          if (!is_shown) row.classList.add('show');
        } else {
          if (is_shown) row.classList.remove('show');
        }
      }
    }

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous">
  </script>
</body>

</html>
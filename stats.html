<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="./styles/global.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .testing {
      background-color: rgb(199, 199, 199);
    }

    :root {
      --color-austin: rgb(10, 132, 255);
      --color-carly: rgb(88, 86, 211);
      --color-carter: rgb(178, 41, 41);
      --color-john: rgb(255, 65, 103);
      --color-jordan: rgb(255, 153, 0);
      --color-kayla: rgb(255, 237, 37);
      --color-kristen: rgb(48, 209, 88);
      --color-kristy: rgb(12, 228, 221);
      --color-stella: rgb(253, 116, 255);
    }
  </style>
</head>


<body class="m-0 p-0 mx-auto" style="max-width: 600px;">
  <nav id="navCont" class="navbar">
    <div class="container-fluid">
      <a class="navbar-brand" href="/nfl-pickem/index.html">
        <div class="d-flex align-items-center mx-0 px-0">
          <i class="fa-solid fa-football fa-sm d-inline-block align-text-top"></i>
          <span class="ps-2">PICK 'EM</span>
        </div>
      </a>
      <div class="navbar-nav d-flex flex-row nav-underline">
        <a id="nav-standings" class="nav-link fw-medium active" href="/nfl-pickem/index.html">Standings</a>
        <a id="nav-schedule" class="nav-link fw-medium" href="/nfl-pickem/schedule.html">Schedule</a>
      </div>
    </div>
  </nav>

  <div id="main" class="container-fluid mx-0 mt-4">
    <div id="chartFilters" class="row mx-0 mb-3">
      <div class="col px-1">
        <label for="playerSelector" class="form-label text-dim1 text-sm3">PLAYER</label>
        <select id="playerSelector" class="form-select bg-main" aria-label="Player Selector">
        </select>
      </div>
      <div class="col px-1">
        <label for="fieldSelector" class="form-label text-dim1 text-sm3">FIELD</label>
        <select id="fieldSelector" class="form-select bg-main" aria-label="Field Selector">
        </select>
      </div>
    </div>

    <div id="chartDiv" class="chart-container">
      <canvas id="chart" width="300" height="500"></canvas>
    </div>
    <div>
      <pre id="chartData"></pre>
    </div>
  </div>

  <script src="./scripts/getSheet.js"></script>
  <script src="./scripts/procStats.js"></script>
  <script src="./scripts/chart.js"></script>
  <script>
    let DATA = {
      Stats: [],
      Chart: {
        labels: [],
        players: [],
        fields: [],
        data: [],
      },
    };

    let chart;

    sendData();

    /* ------------------------------------------------ */

    async function sendData() {
      const data = await getSheet('PlayerStats');
      DATA.Stats = procStats(data);
      procChartData();

      makeChartFilters();
      generateChart();
      setDatasetParsing();
      // updateChart();
      // previewData(chart.config.data.datasets);
    }

    function setDatasetParsing() {
      let datasets = chart.config.data.datasets;
      datasets.forEach((d) => {
        d.parsing = {
          xAxisKey: 'week.v',
          yAxisKey: 'rank.v',
        };
      });
      chart.update();

    }


    /* ------------------------------------------------ */

    function updateChart() {

      let chartData = DATA.Chart;
      let playerNames = document.getElementById('playerSelector').value;
      if (playerNames == 'All Players') {
        playerNames = chartData.players;
      } else {
        playerNames = [playerNames];
      }
      let fieldName = document.getElementById('fieldSelector').value;

      let config = chart.config;
      config.data.datasets = [];
      playerNames.forEach((p) => {
        let playerData = chartData.data.filter((x) => x.player.v == p);
        let dataset = {
          type: 'line',
          label: p,
          data: playerData.map((x) => {
            return {
              x: x.week.v,
              y: x[fieldName].v,
              display: x[fieldName].d,
            }
          })
        };
        dataset = styleDataset(dataset);
        config.data.datasets.push(dataset);
      });

      // average
      if (!fieldName.includes('rank')) {
        let weeks = chartData.data.map((x) => x.week.v);
        weeks = [...new Set(weeks)];
        let avgData = weeks.map((w) => {
          let weekData = chartData.data.filter((x) => x.week.v == w);
          let avg = weekData.reduce((a, b) => a + b[fieldName].v, 0) / weekData.length;
          avg = (fieldName.includes('pct')) ? Math.round(avg * 100) / 100 : Math.round(avg);
          return {
            x: w,
            y: avg,
            display: (fieldName.includes('pct')) ? Math.round(avg * 100) + '%' : avg,
          };
        });
        let avgDataset = {
          type: 'line',
          label: 'Average',
          data: avgData,
        };
        avgDataset = styleDataset(avgDataset);
        config.data.datasets.push(avgDataset);
      }

      let field = chartData.fields.filter((x) => x.field == fieldName)[0];
      let y = config.options.scales.y;
      y.reverse = (field.reverse) ? true : false;
      // y.suggestedMin = field.min;
      // y.suggestedMax = field.max;
      y.min = field.min;
      y.max = field.max;
      y.ticks.callback = function (value, index, values) {
        if (field.label.includes('%')) {
          return Math.round(value * 100) + '%';
        } else {
          return value;
        }
      };

      config.options.plugins.tooltip.itemSort = function (a, b) {
        if (field.reverse) {
          return a.parsed.y - b.parsed.y;
        } else {
          return b.parsed.y - a.parsed.y;
        }
      };

      chart.update();
    }

    /* ------------------------------------------------ */

    function getPlayerColors() {
      let players = DATA.Chart.players;
      let op1 = '.9';
      let op2 = '.7';
      let playerColors = {};
      players.forEach((x) => {
        // get --color-xxx variable
        let colorVar = '--color-' + x.toLowerCase();
        let color = getComputedStyle(document.documentElement).getPropertyValue(colorVar);
        let defaultColor = color.replace('rgb', 'rgba').replace(')', ', ' + op1 + ')');
        let alphaColor = color.replace('rgb', 'rgba').replace(')', ', ' + op2 + ')');
        playerColors[x] = {
          color: defaultColor,
          colorAlpha: alphaColor,
          colorEmphasis: color,
        };
      })

      // average
      let op1avg = '1';
      let op2avg = '.7';
      let avgColor = 'rgb(200, 200, 200)';
      let avgDefault = avgColor.replace('rgb', 'rgba').replace(')', ', ' + op1avg + ')');
      let avgAlpha = avgColor.replace('rgb', 'rgba').replace(')', ', ' + op2avg + ')');
      playerColors['Average'] = {
        color: avgDefault,
        colorAlpha: avgAlpha,
        colorEmphasis: avgColor,
      };

      return playerColors;
    }

    /* ------------------------------------------------ */

    function styleDataset(dataset) {

      let color, colorAlpha;
      let playerColors = getPlayerColors()[dataset.label];
      if (playerColors) {
        color = playerColors.color;
        colorAlpha = playerColors.colorAlpha;
      } else {
        color = 'rgb(255, 255, 255, .4)';
        colorAlpha = 'rgb(255, 255, 255, .2)';
      }

      let style = {
        fill: false,
        backgroundColor: color,
        borderColor: color,
        borderWidth: 3,
        tension: 0.4,
        pointRadius: 3,
        pointBackgroundColor: colorAlpha,
        pointBorderColor: color,
        pointBorderWidth: 1,
        pointHoverRadius: 6,
        pointHoverBackgroundColor: color,
        pointHoverBorderColor: color,
      };

      let d = Object.assign(dataset, style);

      return d;
    }

    /* ------------------------------------------------ */

    function generateChart() {

      let labels = DATA.Chart.labels;
      let players = DATA.Chart.players;
      let data = DATA.Chart.data;
      let weeks = [...new Set(data.map((x) => x.week.v))];
      let datasets = players.map((p) => {
        let dataset = {
          type: 'line',
          label: p,
          data: data.filter((x) => x.player.v == p)
        };
        dataset = styleDataset(dataset);
        return dataset;
      });

      let ctx = document.getElementById('chart').getContext('2d');
      let options = getChartOptions();
      let config = {
        type: 'line',
        data: {
          labels: weeks,
          datasets: datasets,
        },
        options: options,
      };

      // parsing
      // config.options.parsing.xAxisKey = 'week.v';

      let tooltip = config.options.plugins.tooltip;
      tooltip.callbacks = {
        label: function (context) {
          let player = context.dataset.label;
          let itemIndex = context.dataIndex;
          let itemDisplay = context.dataset.data[itemIndex].display;
          let label = player + ': ' + itemDisplay;
          return label;
        },
        title: function (context) {
          let title = context[0].label || '';
          return title;
        },
      };

      let legend = config.options.plugins.legend;
      legend.onClick = function (event, legendItem, legend) {
        let chart = this.chart;
        let playerColors = getPlayerColors();
        let clickedDataset = chart.data.datasets[legendItem.datasetIndex];
        let isDimmed = clickedDataset.borderColor.includes('.2)');
        let someDimmed = chart.data.datasets.some((d) => d.borderColor.includes('.2)'));

        // if clicked dataset is already highlighted, reset all datasets
        if (isDimmed && someDimmed || !isDimmed && !someDimmed) {
          let c = playerColors[clickedDataset.label];
          clickedDataset.borderColor = c.colorEmphasis;
          clickedDataset.backgroundColor = c.colorAlpha;
          clickedDataset.pointBorderColor = c.colorEmphasis;
          clickedDataset.pointBackgroundColor = c.colorAlpha;

          let otherDatasets = chart.data.datasets.filter((x) => x.label != clickedDataset.label);
          otherDatasets = otherDatasets.filter((x) => x.label != 'Average');

          otherDatasets.forEach((d) => {
            d.borderColor = 'rgba(255, 255, 255, .2)';
            d.backgroundColor = 'rgba(255, 255, 255, .05)';
            d.pointBorderColor = 'rgba(255, 255, 255, .05)';
            d.pointBackgroundColor = 'rgba(255, 255, 255, 0)';
          });
          chart.update();
        } else {
          chart.data.datasets.forEach((d) => {
            let c = playerColors[d.label];
            d.borderColor = c.color;
            d.backgroundColor = c.colorAlpha;
            d.pointBorderColor = c.color;
            d.pointBackgroundColor = c.colorAlpha;
          });
          chart.update();
        }
      };

      chart = new Chart(ctx, config);
    }

    function procChartData() {

      let data = DATA.Stats;
      let weeks = [...new Set(data.map((x) => 'WK ' + x.week))];
      // let weeks = [...new Set(data.map((x) => x.week))];
      DATA.Chart.labels = weeks;

      let fields = [
        { field: 'rank', min: 1, max: 9, reverse: true },
        { field: 'games_back', min: 0, max: Math.max(...data.map((x) => x.games_back)), reverse: true },
        // { field: 'wk_wpct', min: .2, max: .9 },
        // { field: 'wk_dog_pct', min: 0, max: .6 },
        // { field: 'wk_dog_wpct', min: 0, max: 1 },
        { field: 'wpct', min: .45, max: .7 },
        { field: 'dog_pct', min: 0, max: .4 },
        { field: 'dog_wpct', min: .25, max: .65 },
      ].map((field) => {
        let f = field.field;
        let label = f.replace(/_/g, ' ');
        label = label.replace('wpct', 'Win %');
        label = label.replace('pct', '%');
        label = label.replace(/\w\S*/g, function (txt) { return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase(); });
        label = label.replace('Games Back', 'GB');
        // if (f.includes('cum')) {
        //   label += ' (cumul)';
        //   label = label.replace('Cum ', '');
        // }

        field.label = label;
        return field;
      });
      DATA.Chart.fields = fields;

      let players = [...new Set(data.map((x) => x.player))];
      DATA.Chart.players = players;

      let cdata = data.map((x) => {
        let obj = {};
        let fields = Object.keys(x);
        fields = fields.filter((f) => !['rankOrder', 'rankVal'].includes(f));
        fields.forEach((f) => {
          let val = x[f];
          let display = val;
          if (f == 'rank') {
            val = x['rankVal'];
            display = x['rank'];
          }
          if (f.includes('pct')) {
            display = Math.round(val * 100) + '%';
          }
          obj[f] = {
            v: val,
            d: display,
          };
        });
        return obj;
      });

      DATA.Chart.data = cdata;
    }


    /* ------------------------------------------------ */

    function makeChartFilters() {
      let chartDiv = document.getElementById('chartFilters');
      let chartData = DATA.Chart;
      let fields = chartData.fields;
      let players = chartData.players;

      let fieldSelector = document.getElementById('fieldSelector');
      fieldSelector.addEventListener('change', function () {
        updateChart();
      });
      fields.forEach((f) => {
        let field = f.field;
        let label = f.label;
        let option = document.createElement('option');
        option.setAttribute('value', field);
        option.innerText = label;
        fieldSelector.appendChild(option);
      });

      let playerSelector = document.getElementById('playerSelector');
      playerSelector.addEventListener('change', function () {
        updateChart();
      });
      let option = document.createElement('option');
      option.setAttribute('value', 'All Players');
      option.setAttribute('selected', true);
      option.innerText = 'All Players';
      playerSelector.appendChild(option);
      players.forEach((p) => {
        if (p == 'Average') return;
        let option = document.createElement('option');
        option.setAttribute('value', p);
        option.innerText = p;
        playerSelector.appendChild(option);
      });
    }

    function previewData(dataset) {
      let code = '<div><pre>' + JSON.stringify(dataset, null, 2) + '</pre></div>';
      document.body.innerHTML = code;
    }

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous">
  </script>
</body>

</html>